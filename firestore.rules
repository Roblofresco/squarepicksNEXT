rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- users Collection ---
    match /users/{userId} {
      allow create: if request.auth.uid == userId;
      allow read: if request.auth.uid == userId;
      allow update: if request.auth.uid == userId;
      allow delete: if false;

      match /address/{document} {
        allow create, read, write, delete: if request.auth.uid == userId;
      }
      match /bets/{document} {
        allow create, read, write, delete: if request.auth.uid == userId;
      }
      match /wallet/{document} {
        allow create, read, write, delete: if request.auth.uid == userId;
      }
      // --- private wins Subcollection (per-user quarter/final wins) ---
      match /wins/{winId} {
        // Users can read their own wins; server (Admin SDK) writes
        allow read: if request.auth.uid == userId;
        allow create, update, delete: if false;
      }
    }

    // --- games Collection ---
    match /games/{gameDocId} {
      allow read: if true;
      allow create, write, delete: if false;
    }

    // --- sports Collection ---
    match /sports/{sportDocId} {
      allow read: if true;
      allow create, write, delete: if false;
    }

    // --- teams Collection ---
    match /teams/{teamDocId} {
      allow read: if true;
      allow create, write, delete: if false;
    }

    // --- boards Collection ---
    match /boards/{boardId} {
      allow read: if resource.data.status == "open" || request.auth != null;
      allow create: if request.auth != null;
      allow update: if false;
      allow delete: if false;

      // --- squares Subcollection (under boards) ---
      match /squares/{squareId} {
        // Squares contain sensitive userIDs; disallow client reads/writes
        allow create, read, update, delete: if false;
      }

      // --- winners Subcollection (public, non-PII summary) ---
      match /winners/{periodId} {
        // Public can read winner index/square/metadata; server writes
        allow read: if true;
        allow create, update, delete: if false;
      }
    }

    // --- sweepstakes Collection ---
    match /sweepstakes/{sweepstakeDocId} {
      allow read: if true;
      allow create, write, delete: if false;

      // --- participants Subcollection (under sweepstakes) ---
      match /participants/{participantId} {
        allow create: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)) == request.resource.data.userID;
        allow read: if request.auth != null;
        allow write, delete: if false;
      }
    }

    // --- transactions Collection ---
    match /transactions/{transactionId} {
      allow create: if false;
      allow read: if request.auth != null && resource.data.userID == request.auth.uid;
      allow write, delete: if false;
    }
    
    // No other top-level collections like api_keys, notifications, sweepstakes_entries from memory.

    // +++ START: NEW notifications Collection Rules +++
    match /notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userID;
      allow update: if request.auth != null && 
                       request.auth.uid == resource.data.userID &&
                       request.writeFields.hasOnly(['isRead']) &&
                       request.resource.data.isRead == true;
      allow create: if request.auth != null;
    }
    // +++ END: NEW notifications Collection Rules +++
  }
} 